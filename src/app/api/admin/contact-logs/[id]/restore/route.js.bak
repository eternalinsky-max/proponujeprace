// src/lib/firebase-admin-init.js
import 'server-only';
import { initializeApp, getApps, cert, applicationDefault } from 'firebase-admin/app';
import { getAuth } from 'firebase-admin/auth';

/**
 * Ініціалізація Firebase Admin лише один раз у процесі.
 * Підтримує:
 *  - FIREBASE_SERVICE_ACCOUNT_BASE64 (рекомендовано на Windows)
 *  - FIREBASE_SERVICE_ACCOUNT_JSON  (сирий JSON зі \\n)
 * Якщо обидва відсутні — fallback на applicationDefault().
 */
export function initFirebaseAdmin() {
  const apps = getApps();
  if (apps.length) return apps[0];

  const b64 = process.env.FIREBASE_SERVICE_ACCOUNT_BASE64;
  const raw = process.env.FIREBASE_SERVICE_ACCOUNT_JSON;

  let svc = null;

  if (b64 && b64.trim()) {
    try {
      svc = JSON.parse(Buffer.from(b64, 'base64').toString('utf8'));
    } catch {
      // Не кидаємо на імпорті: хай помилка проявиться під час реального виклику
      throw new Error('FIREBASE_SERVICE_ACCOUNT_BASE64: invalid base64 or JSON');
    }
  } else if (raw && raw.trim()) {
    try {
      svc = JSON.parse(raw);
    } catch {
      throw new Error('FIREBASE_SERVICE_ACCOUNT_JSON: invalid JSON');
    }
  }

  // Якщо svc немає — використовуємо ADC (application default credentials)
  if (!svc) {
    return initializeApp({
      credential: applicationDefault(),
      projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID, // опційно
      storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET, // опційно
    });
  }

  // Відновлюємо перенос рядків у приватному ключі
  if (typeof svc.private_key === 'string' && svc.private_key.includes('\\n')) {
    svc.private_key = svc.private_key.replace(/\\n/g, '\n');
  }

  return initializeApp({
    credential: cert(svc),
    projectId: svc.project_id || process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET, // опційно
  });
}

/** Зручно: отримати admin auth (авто-ініт якщо треба) */
export function getAdminAuth() {
  const app = initFirebaseAdmin();
  return getAuth(app);
}
